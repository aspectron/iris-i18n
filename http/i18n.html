<script>
	var i18n = { }
</script>

<polymer-element name="i18n-tabs" attributes="current list">
	<template>
	<style>
		* {
			font-size: 12px;
			cursor: default;
		}

		#container {
			width: 100%;
		}

		#list {
			clear:left;
		}

		.tab {
			float:left;
			position:relative;
			height: 18px;
			border-top: 1px solid #ccc;
			border-left: 1px solid #ccc;
			padding: 4px 6px 4px 6px;
			background-color: white;
			z-index: 1;

			margin-left: 0px;
			margin-top: 2px;
			color: #ccc;
			white-space: nowrap;
		}

		.tab:last-child {
			border-right: 1px solid #ccc;
		}
		.selected, .selected:last-child {
			color: #333;
			height: 19px;
			border-top: 1px solid #888;
			border-left: 1px solid #888;
			border-right: 1px solid #888;
			background-color: #BEE2FA;
			color: black;
			z-index: 3;
		}

		#tabs{
			position: relative;
			overflow: hidden;
			height: 28px;
			margin-left: 4px;
		}

		#list {
			overflow:hidden;
			white-space: nowrap;
			position:absolute;
			top: 0px;
			left: 0px;
			transition:left .5s;
		}

		.tab {
			float:none;
			display:inline-block;
		}

		#leftArrow, #rightArrow {
			padding: 0px 5px 6px;
			position: absolute;
			background-color: #F1F1F1;
			border: 1px solid #F1F1F1;
			z-index: 4;
			font-weight: bold;
			font-size: 28px;
			color: #000;
			line-height: 22px;
		}
		#leftArrow {
			left:0;
		}

		#rightArrow {
			right:0;
		}
		.hidden{
			display: none;
		}
	</style>
	<div id="container">
		<div id="caption">
			{{title}}
		</div>
		<div id="tabs">
			<div id="list" on-transitionend="{{showHideArrow}}"><template repeat="{{list as tab}}"><div id="tab-{{tab.ident}}" ident="{{tab.ident}}" on-click={{selectTab}} class="tab {{ tab.selected ? 'selected' : ''}}">
						{{ (tab.text||tab.ident) | toUpperCase }}
					</div></template></div>
			<div id="leftArrow" on-click="{{onLeftArrowClick}}"> &lsaquo; </div>
			<div id="rightArrow" on-click="{{onRightArrowClick}}"> &rsaquo; </div>
		</div>
	</div>
	</template>
	<script>
		Polymer('i18n-tabs', {
			moveStep: 100,

			listChanged: function(){
				this.showHideArrow();
				this.selectContent();
			},

			selectContent: function(){
				var selected = _.find(this.list, function(tab) {return tab.selected});
				selected && this.select(selected.ident);
			},

			toUpperCase : function(v) {
				return v.toUpperCase();
			},

			showHideArrow: function() {
				var outerBox = this.$.tabs.getBoundingClientRect();
				var innerBox = this.$.list.getBoundingClientRect();
				this.$.leftArrow.classList.toggle('hidden', (outerBox.left <= innerBox.left));
				this.$.rightArrow.classList.toggle('hidden', (outerBox.right >= innerBox.right));

				if (innerBox.width > outerBox.width) {
					if (innerBox.left > outerBox.left) {
						this.$.list.style.left = '0px';
					}else if(innerBox.right < outerBox.right ){
						this.move(outerBox.right - innerBox.right);
					}
				}
			},

			move: function(step){
				this.$.list.style.position = 'absolute';
				this.$.list.style.left = parseInt((this.$.list.style.left || '0px').replace('px', '')) + step + 'px';
			},

			onLeftArrowClick: function(){
				this.move(this.moveStep)
			},

			onRightArrowClick: function() {
				this.move(-this.moveStep)
			},

			domReady: function(){
				this.showHideArrow();
				this.selectContent();
			},

			getItem : function(id) {
				return document.querySelector("::shadow #"+id);
			},


			selectTab : function(e,n,item) {
				this.select(item.id.substring(4));
			},			

			select : function(id) {
				var self = this;
				_.each(this.list, function(tab) {
					tab.selected = (tab.ident == id);
					var $ = self.getItem(tab.ident);
					if($)
						$.style.display = (tab.selected) ? 'inherit' : 'none';
					else
						console.error("#"+tab.ident+" not found (tab target)")
				})
			}
		});
	</script>
</polymer-element>


<polymer-element name="i18n-entry" attributes="data">
	<template>

		<style>
			:host{
				width: 200px;
				padding: 5px 5px 0px 5px;
				display: block;
			}
			#content{
				padding: 5px;
				border-bottom: 1px solid #ddd;
			}

			.missing{
				background-color: rgba(255, 0, 0, 0.05);
			}
			.selected {
				background-color: #bffffe;
			}
			.locale{
				min-height: 18px;
			}
			.locale .mis{
				background-color: #fa2352;
				color: #FFF;
				padding: 1px 2px;
				font-size: 10px;
			}
		</style>
		<div id="content" hash="{{data.hash}}" class="{{ { selected : selected, missing: missing.length } | tokenList }}" on-click="{{select}}">
			{{data.locale.en}}
			<div class="locale">
				<template repeat="{{ missing as l}}">
					<span class="mis">{{l | toUpperCase()}}</span>
				</template>
			</div>
		</div>
	</template>
	
	<script>
		Polymer("i18n-entry", {
			dataChanged: function(){
				var self = this, data = self.data || {};
				//self.locs = _.keys(data.locale || []);
				var editLanguages = document.querySelector("i18n-ctl").getLanguages(true);
				self.missing = [];
				_.each(editLanguages, function(l){
					if(!data.locale[l.ident]){
						self.missing.push(l.ident);
					}
				});
			},

			ready : function() {
				this.selected = false;
				this.super();
			},
			toUpperCase: function(v){
				return (v+'').toUpperCase();
			},

			isMissing: function(ident){
				return this.missing.indexOf(ident) > -1;
			},

			toJSON : function(v) {
				return JSON.stringify(v);
			},

			select : function() {
				var browser = document.querySelector("i18n-browser");
				browser.select(this);

				var editor = document.querySelector("i18n-editor");
				editor.data = this.data;
			}
		})
	</script>
</polymer-element>


<polymer-element name="i18n-browser" attributes="list" layout vertical>
	<template>

		<style>
			#content {
				overflow-y: scroll;
				overflow-x: hidden;
				/*border: 0px solid blue;*/
			}
		</style>

		<div id="content">
			<template repeat="{{ list as entry }}">
				<i18n-entry data="{{entry}}" list="{{list}}"></i18n-entry>
			</template>
		</div>
	</template>
	
	<script>
		Polymer("i18n-browser", {
			ready : function() {
				this.super();
			},

			select : function(e) {
				var entries = this.getEntries();
				_.each(entries, function(entry) {
					entry.selected = false;
				})
				e.selected = true;
			},

			getSelected: function(){
				var entries = this.getEntries();
				return _.find(entries, function(entry) {
					return entry.selected;
				});
			},

			getEntries: function(){
				return this.shadowRoot.querySelectorAll("i18n-entry");
			}
		})
	</script>
</polymer-element>


<polymer-element name="i18n-editor" attributes="data">
	<template>

		<style>
			#content {
				/*border: 1px solid green;*/
				border-width: 0px 1px 1px 0px;
			}

			input {
				width: 600px;
			}

			.lang {
				text-align: right;
				padding: 4px;
			}

			.source {
				padding: 8px;
				font-size: 16px;
			}

			textarea {
				height: 200px;
			}

			#info {
				margin-top: 24px;
				margin-left: 12px;
			}

			.files {
				margin-left: 12px;
			}

			#delete {
				float: right;
				background-image: url("images/delete.svg");
				width: 24px;
				height: 24px;
				margin-right: 8px;
				margin-top: 4px;
			}
			
		</style>

		<div id="content">
			<template if="{{!data}}">
				Please select text entry.
			</template>

			<template if="{{data}}">
				<div id="delete" on-click="{{deleteEntry}}" title="Delete Entry"></div>

				<table>

					<tr><td class='lang'>English (en):</td><td class='source'>{{data.locale.en}}</td></tr>

					<template repeat="{{ ctl.languages as locale }}">
						<template if="{{locale.editingEnabled && locale.ident != 'en' }}">
							<tr>
								<td class='lang'>
								{{locale.name}} ({{locale.ident}}):
								</td>
								<td>
									<template if="{{!data.multiline}}">
										<input id="{{locale.ident}}" type="text" value="{{data.locale[locale.ident]}}" on-keyup="{{update}}"/>
									</template>
									<template if="{{data.multiline}}">
										<textarea id="{{locale.ident}}" value="{{data.locale[locale.ident]}}" on-keyup="{{update}}"></textarea>
									</template>
								</td>
							</tr>
						</template>
					</template>
				</table>

				<div id="info">
					<div>CREATED: {{ data.ts | toDate }}</div>
					<div>FILES:</div>
					<div class="files">
						<template repeat="{{ data.files as file }}">
							<div>
								{{file}}
							</div>
						</template>
					</div>
					<!-- <hr />
					<div>
						 {{ data | toJSON }} 
					</div> -->
				</div>
			</template>
		</div>

	</template>
	<script>
		Polymer("i18n-editor", {
			domReady : function() {
				var self = this;
				i18n.rpc.on('update', function(args) {
					if(args.hash == self.data.hash) {
						var input = self.shadowRoot.querySelector('#'+args.locale);
						input && (input.value = args.text);
					}
				})

				this.ctl = document.querySelector("i18n-ctl");
			},

			dataChanged : function(v) {

			},

			attributeChanged : function(v) {
				console.log(arguments);
			},

			toJSON : function(v) {
				return JSON.stringify(v);
			},

			toDate : function(ts) {
			    var a = new Date(ts);
			    var year = a.getFullYear();
			    var month = a.getMonth()+1; month = month < 10 ? '0' + month : month;
			    var date = a.getDate(); date = date < 10 ? '0' + date : date;
			    var hour = a.getHours(); hour = hour < 10 ? '0' + hour : hour;
			    var min = a.getMinutes(); min = min < 10 ? '0' + min : min;
			    var sec = a.getSeconds(); sec = sec < 10 ? '0' + sec : sec;
			    var time = year + '-' + month + '-' + date + ' ' + hour + ':' + min + ':' + sec;
			    return time;
			},

			update : function(e, n, el) {
				i18n.rpc.dispatch({
					op : 'update',
					hash : this.data.hash,
					locale : el.id,
					text : el.value
				})
				// console.log(arguments);

				var selectedEntry = document.querySelector("i18n-browser").getSelected();
				if (selectedEntry) {
					selectedEntry.dataChanged();
				};
			},

			deleteEntry : function() {
				if(window.confirm("Are you sure you want to delete this entry?")) {
					console.log("TODO - DELETE ENTRY!");

					// @mattoo - DELETE ENTRY AND MAKE SURE IT REFLECTS TO OTHER INSTANCES
					i18n.rpc.dispatch({
						op : 'delete',
						hash : this.data.hash,
						// locale : el.id,
						// text : el.value
					})
				}
			}
		})
	</script>

</polymer-element>



<polymer-element name="i18n-language-selector" attributes="locale toggle">
	<template>

		<style>
			#content {
				float: left;
				min-width: 60px;
				height: 16px;
				border: 1px solid #ccc;
				margin: 4px;
				padding: 4px;
				overflow: hidden;
				text-align: center;
				position: relative;
			}

			.enabled {
				background-color: #c2ffd1;
				/*color: #ffffff;*/
			}
		</style>

		<div id="content" class="{{ { enabled : locale[toggle] } | tokenList }}" on-click="{{onClick}}">
			{{locale.name}}
		</div>

	</template>
	
	<script>
		Polymer("i18n-language-selector", {
			ready : function() {
				this.super()
			},
			onClick: function(e, a, b){
				var self = this, locale = self.locale, toggle = self.toggle;
				locale[toggle] = !locale[toggle];
				self.fire('updated', locale);
			}
		})
	</script>
</polymer-element>



<polymer-element name="i18n-ctl">
	<template>
		<style>
		</style>

		<core-ajax auto url="/i18n/get" handleAs="json" on-core-response="{{updateData}}"></core-ajax>
		<div id="content">
			<i18n-tabs> </i18n-tabs>
			<div id="tab-content-edit">
				<template repeat="{{languages as locale}}">
					<i18n-language-selector locale="{{locale}}" toggle="editingEnabled" on-updated="{{onEditingChange}}"></i18n-language-selector>
				</template>
			</div>
			<div id="tab-content-site">
				<template repeat="{{languages as locale}}">
					<i18n-language-selector locale="{{locale}}" toggle="enabled" on-updated="{{onStateChange}}"></i18n-language-selector>
				</template>
			</div>
		</div>

	</template>
	<script>
		Polymer("i18n-ctl", {
			ready : function() {
				var self = this;
				self.super();
				var tabs = self.shadowRoot.querySelector("i18n-tabs");
				tabs.list = [{ident:'edit', text:'Editing languages', selected : true },{ident:'site', text:'Site languages'}];
				tabs.getItem = function(id) {
					return self.$['tab-content-'+id];
				}
			},

			domReady : function() {
				var self = this;
				i18n.rpc.on('locale-update', function(args) {

					var locale = _.find(self.languages, function(v) { return v.ident == args.locale.ident; })
					if(locale)
						locale.enabled = args.locale.enabled;

					var entries = document.querySelector("i18n-browser").getEntries();
					_.each(entries, function(entry){
						entry.dataChanged();
					});
						
				})

			},

			onStateChange: function(e){
				var locale = e.detail;
				i18n.rpc.dispatch({
					op : 'locale-update',
					locale : locale
				});
				if (locale.editingEnabled != undefined) {
					this.setLocale(locale);
				}

				var entries = document.querySelector("i18n-browser").getEntries();
				_.each(entries, function(entry){
					entry.dataChanged();
				});
			},

			onEditingChange: function(e){
				var locale = e.detail;
/*				i18n.rpc.dispatch({
					op : 'locale-update',
					locale : locale
				});
*/				if (locale.editingEnabled != undefined) {
					this.setLocale(locale);
				}

				var entries = document.querySelector("i18n-browser").getEntries();
				_.each(entries, function(entry){
					entry.dataChanged();
				});
			},

			setLocale: function(locale){
				var info = JSON.parse(localStorage['i18n'] || "{}");
				info[locale.ident] = locale.editingEnabled;
				localStorage['i18n'] = JSON.stringify(info);
			},

			getlocale: function(ident){
				var info = JSON.parse(localStorage['i18n'] || "{}");
				return info[ident];
			},

			getLanguages: function(editing, enabled){
				return _.filter(this.languages, function(l){
					if (editing != undefined && l.editingEnabled != editing) {
						return false;
					};
					if (enabled != undefined && l.enabled != enabled) {
						return false;
					};
					return true;
				});
			},

			updateData : function(e, ajax) {
				var self = this;
				self.config = ajax.response.config;
				var languages = self.config.languages;
				_.each(languages, function(lang, locale) {
					lang.ident = locale;
				});

				if (ajax.response.locales && ajax.response.locales != '*') {
					var locales = ajax.response.locales.split(' ');
					languages = _.filter(languages, function(l){
						return (locales.indexOf(l.ident) > -1);
					});
				};

				languages = _.filter(languages, function(l){
					l.editingEnabled = !!self.getlocale(l.ident);
					return (l.ident != 'en');
				});

				self.languages = _.values(languages);

				if(!self.browser)
					self.browser = document.querySelector("i18n-browser");
				
				self.browser.list = _.values(ajax.response.entries);
			}
		})
	</script>

</polymer-element>

